# AST （抽象语法树 abstract syntax tree）
https://astexplorer.net/
https://github.com/jamiebuilds/the-super-tiny-compiler/blob/master/the-super-tiny-compiler.js
http://resources.jointjs.com/demos/javascript-ast



# 基本流程
```
       @babel/parser         @babel/traverse        @babel/generator
code  -------------->  AST ---------------->  AST -----------------> code

```

使用 @babel/cli 编译js文件的核心流程：
```js
// step 1. @babel/parser
const file = normalizeFile(     
  config.passes,
  normalizeOptions(config),
  code,
  ast,
);

// step 2.  @babel/traverse
transformFile(file, config.passes);   

const opts = file.opts;
// step 3. @babel/generator
const { outputCode, outputMap } =
  opts.code !== false ? generateCode(config.passes, file) : {};   

return {
  metadata: file.metadata,
  options: opts,
  ast: opts.ast === true ? file.ast : null,
  code: outputCode === undefined ? null : outputCode,
  map: outputMap === undefined ? null : outputMap,
  sourceType: file.ast.program.sourceType,
};
```

## step 1. @babel/parser
依赖 acorn, acorn-jsx。 
这个过程分为两个阶段：词法分析和语法分析。  
词法分析阶段把字符串形式的代码转换为令牌流（tokens）。  
语法分析：把令牌流转换为AST形式。  

## step 2. @babel/traverse
接收AST并对其进行遍历，在此过程中对节点进行添加，更新以及移除等操作。这是Babel编译器中最复杂的过程，同时也是插件将要介入工作的部分。
每个插件的实现都是采用 Visitor 模式，plugins 是串行执行。  
babelOptions中间的 presets 属性配置，实际上是一些plugin的集合预设。
例如: babel-preset-react 等价对应于以下plugins的集合：
```js
{
  plugins: [
    "babel-plugin-transform-react-jsx",
    "babel-plugin-syntax-jsx",
    "babel-plugin-transform-react-display-name" 
  ]
}
```

## step 3. @babel/generator
代码的生成并且生成 sourcemap。  

扩展：  
1. eslint
2. 实现一个 prettier 插件，实际上就是在上述过程过，去掉了第二步骤，稍微定制一下第三步可以完成。
