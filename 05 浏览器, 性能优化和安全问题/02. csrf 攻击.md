# CSRF 攻击
方法：通过诱骗用户点击一个链接而进入到黑客自己的站点.
如果恰好在这之前用户之前登陆过一些其他的正常站点，那么在黑客的站点中可以共享正常站点的cookie信息. 
虽然浏览器做了限制，黑客是无法直接提取其他站点cookie信息，但是黑客可以利用这些cookie信息给正常的站点发送请求. 如果服务端不做预防的话，则黑客可以冒充用户发送请求做任意操作.
这种攻击就称为 CSRF 攻击.

https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet

 

# CSRF漏洞检测：
检测网站的CSRF漏洞最简单的方法就是：
1. 抓取站点的的HTTP请求，
2. 将该HTTP请求去掉Referer字段，再重新请求，
如果server返回成功，则基本可以断定该站点存在CSRF漏洞.

还有一些功能强大的专门工具用来做站点的CSRF漏洞检测：CSRFTester, CSRF Request Builder等.
CSRFTester工具，检测原理如下：
1. 首先抓取我们再浏览器中访问过的所有链接和所有表单等信息
2. 然后通过CSRFTest修改相应的表单等信息，重新提交，相当于伪造了一次用户请求.
如果修改后的测试请求被server接受，则说明站点存在CSRF漏洞.

# 防御CSRF攻击：
防御 CSRF 攻击主要有三种策略：
1. 验证 HTTP Referer 字段
2. 在请求地址中添加 token 并验证
3. 在 HTTP 头中自定义属性并验证

## 1. 验证 HTTP Referer 字段
根据HTTP协议，每个HTTP请求头中有一个叫Referer的字段，它记录了该请求的来源地址.
正常情况下，在站点中发送HTTP请求，这个referer字段是该站点的信息.
但是在黑客的站点发送HTTP请求的referer字段，指定的是黑客自己的站点.
在站点的服务端对每个http请求的referer进行严格校验，可以有效防止CSRF攻击.
但是，这种方法也不是万无一失的. referer的值是由浏览器提供，并不能保证浏览器自身没有没有安全漏洞.
如果浏览器发送请求的referer值被篡改了，则这种方法会变得无效.


## 2. 在请求地址中添加 token 并验证
CSRF攻击之所以能够成功的关键问题在于利用用户的cookie信息, HTTP请求中的身份验证信息都在用户的cookie中. 要防止CSRF攻击的有效方法就是让HTTP请求中放置非cookie的身份验证信息.



CSRF 攻击之所以能够成功，是因为黑客可以完全伪造用户的请求，该请求中所有的用户验证信息都是存在于 cookie 中，因此黑客可以在不知道这些验证信息的情况下直接利用用户自己的 cookie 来通过安全验证。要抵御 CSRF，关键在于在请求中放入黑客所不能伪造的信息，并且该信息不存在于 cookie 之中。可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。

        这种方法要比检查 Referer 要安全一些，token 可以在用户登陆后产生并放于 session 之中，然后在每次请求时把 token 从 session 中拿出，与请求中的 token 进行比对，但这种方法的难点在于如何把 token 以参数的形式加入请求。对于 GET 请求，token 将附在请求地址之后，这样 URL 就变成 http://url?csrftoken=tokenvalue。 而对于 POST 请求来说，要在 form 的最后加上 <input type=”hidden” name=”csrftoken” value=”tokenvalue”/>，这样就把 token 以参数的形式加入请求了。但是，在一个网站中，可以接受请求的地方非常多，要对于每一个请求都加上 token 是很麻烦的，并且很容易漏掉，通常使用的方法就是在每次页面加载时，使用 javascript 遍历整个 dom 树，对于 dom 中所有的 a 和 form 标签后加入 token。这样可以解决大部分的请求，但是对于在页面加载之后动态生成的 html 代码，这种方法就没有作用，还需要程序员在编码时手动添加 token。

         该方法还有一个缺点是难以保证 token 本身的安全。特别是在一些论坛之类支持用户自己发表内容的网站，黑客可以在上面发布自己个人网站的地址。由于系统也会在这个地址后面加上 token，黑客可以在自己的网站上得到这个 token，并马上就可以发动 CSRF 攻击。为了避免这一点，系统可以在添加 token 的时候增加一个判断，如果这个链接是链到自己本站的，就在后面添加 token，如果是通向外网则不加。不过，即使这个 csrftoken 不以参数的形式附加在请求之中，黑客的网站也同样可以通过 Referer 来得到这个 token 值以发动 CSRF 攻击。这也是一些用户喜欢手动关闭浏览器 Referer 功能的原因。

      （3）在 HTTP 头中自定义属性并验证

        这种方法也是使用 token 并进行验证，和上一种方法不同的是，这里并不是把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。通过 XMLHttpRequest 这个类，可以一次性给所有该类请求加上 csrftoken 这个 HTTP 头属性，并把 token 值放入其中。这样解决了上种方法在请求中加入 token 的不便，同时，通过 XMLHttpRequest 请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会透过 Referer 泄露到其他网站中去。

        然而这种方法的局限性非常大。XMLHttpRequest 请求通常用于 Ajax 方法中对于页面局部的异步刷新，并非所有的请求都适合用这个类来发起，而且通过该类请求得到的页面不能被浏览器所记录下，从而进行前进，后退，刷新，收藏等操作，给用户带来不便。另外，对于没有进行 CSRF 防护的遗留系统来说，要采用这种方法来进行防护，要把所有请求都改为 XMLHttpRequest 请求，这样几乎是要重写整个网站，这代价无疑是不能接受的。