# 代码编辑器

目前，市面上最著名的代码编辑器是 monaco-editor, VS code 里面的核心编辑器就是它。
通过对 monaco-editor 进行集成和改造可以轻松地实现一个 webIDE。
下面通过庖丁解牛的方式来初步地剖析一个代码编辑器是如何实现的。

# html 上的文本输入问题

在 html 上进行文本输入，通常有两种方式：

1. 通过 form 元素(textarea, input 等)完成的，这样做的缺陷在于无法给文本内容赋予丰富的样式。
2. 通过设置 html 元素的 contenteditable 属性为 true，让用户可以直接地编辑 html 内容本身。
   使用这种方法的缺陷在于，这种方法不能直接添加 html 标签，只能添加文本内容，必须在编辑完成后，将 html 内容中的数据取出来，和文档源内容进行合并。
   使用第二种方法的解决方案文本编辑器有 ck-editor。

monaco-editor 里面实现方案非常巧妙：

1. 整个编辑器容器的 div 的 position 设置为 relative.
2. 每一行代码是一个 div，里面的内容是其中 span 元素， 由 span 元素中的样式来完成 代码的高亮显示。
3. 每一行的 div 的 position 为 absolute, 其 top 和 height 被严格计算。
4. 在容器底部放置一个 position: absolute, z-index: 2000 的 textarea 元素。
   设置 textarea 的宽高为 1，背景透明，所以 UI 上是不可见的。
5. 当鼠标在某一行代码的 div 上进行点击时，设置 textarea 的 left，top 为当前点击位置，并且 focus 到 textarea 元素上。
   虽然 textarea 元素为不可见，因为 focus 状态触发，光标就会开始显示。
6. 监听该 textarea 的输入事件，快速修正整个文档的输入 input，重新执行 UI = f(input)

## monaco-editor 的 DOM 结构

```css
/* 编辑器容器 */
.monaco-editor {
  background: ###;
  color: ###;
  position: relative;
  overflow: visible;
}

/* 代码容器 */
.overflow-guard {
  position: relative;
  overflow: hidden;
}

/* 代码提示下拉框 */
.overflowingContentWidgets {
}

/* 右键菜单 */
.context-view {
  position: absolute;
  z-index: 2000;
}
```

```html
<div
  class="monaco-editor"
  data-uri="inmemory://model/2"
  style="width: 800px; height: 450px"
>
  <div
    data-mprt="3"
    class="overflow-guard"
    style="width: 800px; height: 450px;"
  >
    ...(代码的内容)
  </div>
  <div data-mprt="2" class="overflowingContentWidgets">
    ...（提示下拉框的内容）
  </div>
  <div class="context-view monaco-menu-container bottom left"></div>
</div>
```

## 代码容器结构

```html
<div data-mprt="3" class="overflow-guard" style="width: 800px; height: 450px;">
  <div
    class="margin"
    role="presentation"
    aria-hidden="true"
    style="position: absolute; will-change: transform; top: 0px; height: 4428px; width: 84px;"
  >
    <div
      class="glyph-margin"
      style="left: 0px; width: 18px; height: 4428px;"
    ></div>
    <div
      class="margin-view-zones"
      role="presentation"
      aria-hidden="true"
      style="position: absolute;"
    ></div>
    <div
      class="margin-view-overlays"
      role="presentation"
      aria-hidden="true"
      style='position: absolute; width: 84px; font-family: Menlo, Monaco, "Courier New", monospace; font-weight: normal; font-size: 12px; line-height: 18px; letter-spacing: 0px; height: 4464px;'
    >
      <div style="position:absolute;top:342px;width:100%;height:18px;">
        <div class="cldr folding" style="left:58px;width:26px;"></div>
        <div class="line-numbers" style="left:18px;width:40px;">左侧的行数标记</div>
      </div>
      ...    
    </div>
  </div>
  <div
    class="monaco-scrollable-element editor-scrollable vs mac"
    role="presentation"
    data-mprt="5"
    style="position: absolute; overflow: hidden; left: 84px; width: 716px; height: 450px;"
  >
    <div
      class="lines-content monaco-editor-background"
      style="position: absolute; overflow: hidden; width: 1e+06px; height: 1e+06px; will-change: transform; top: 0px; left: 0px;"
    >
      <div
        class="view-overlays"
        role="presentation"
        aria-hidden="true"
        style="position: absolute; height: 0px; width: 1012px;"
      >
        <div
          style="position: absolute; top: 342px; width: 100%; height: 18px;"
        ></div>
        <div style="position: absolute; top: 360px; width: 100%; height: 18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position: absolute; top: 378px; width: 100%; height: 18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position: absolute; top: 396px; width: 100%; height: 18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position: absolute; top: 414px; width: 100%; height: 18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position: absolute; top: 432px; width: 100%; height: 18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:324px;width:100%;height:18px;">
          <div
            class="cdr squiggly-error"
            style="left:0px;width:145px;height:18px;"
          ></div>
        </div>
        <div style="position:absolute;top:252px;width:100%;height:18px;"></div>
        <div style="position:absolute;top:306px;width:100%;height:18px;">
          <div
            class="cdr squiggly-error"
            style="left:0px;width:80px;height:18px;"
          ></div>
        </div>
        <div style="position:absolute;top:234px;width:100%;height:18px;"></div>
        <div style="position:absolute;top:198px;width:100%;height:18px;"></div>
        <div style="position:absolute;top:216px;width:100%;height:18px;"></div>
        <div style="position:absolute;top:162px;width:100%;height:18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:180px;width:100%;height:18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:144px;width:100%;height:18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:126px;width:100%;height:18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:108px;width:100%;height:18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:90px;width:100%;height:18px;"></div>
        <div style="position:absolute;top:72px;width:100%;height:18px;"></div>
        <div style="position:absolute;top:54px;width:100%;height:18px;"></div>
        <div style="position:absolute;top:36px;width:100%;height:18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:18px;width:100%;height:18px;">
          <div class="cigr" style="left:0px;height:18px;width:32.125px"></div>
        </div>
        <div style="position:absolute;top:0px;width:100%;height:18px;"></div>
        <div
          style="position: absolute; top: 288px; width: 100%; height: 18px;"
        ></div>
        <div style="position:absolute;top:270px;width:100%;height:18px;">
          <div class="current-line" style="width:1012px; height:18px;"></div>
        </div>
      </div>
      <div role="presentation" aria-hidden="true" class="view-rulers"></div>
      <div
        class="view-zones"
        role="presentation"
        aria-hidden="true"
        style="position: absolute;"
      ></div>
      <div
        class="view-lines"
        role="presentation"
        aria-hidden="true"
        data-mprt="7"
        style='position: absolute; font-family: Menlo, Monaco, "Courier New", monospace; font-weight: normal; font-size: 12px; line-height: 18px; letter-spacing: 0px; width: 1012px; height: 4464px;'
      >
        <div style="top: 342px; height: 18px;" class="view-line">
          <span
            ><span class="mtk1">(</span><span class="mtk6">function</span
            ><span class="mtk1">&nbsp;(global,&nbsp;</span
            ><span class="mtk6">undefined</span
            ><span class="mtk1">)&nbsp;{</span></span
          >
        </div>
        <div style="top: 360px; height: 18px;" class="view-line">
          <span
            ><span class="vs-whitespace">→&nbsp;&nbsp;&nbsp;</span
            ><span class="mtk20">"use&nbsp;strict"</span
            ><span class="mtk1">;</span></span
          >
        </div>
        <div style="top: 378px; height: 18px;" class="view-line">
          <span
            ><span class="vs-whitespace">→&nbsp;&nbsp;&nbsp;</span
            ><span class="mtk1"
              >undefinedVariable&nbsp;=&nbsp;{};&nbsp;undefinedVariable.bar&nbsp;=&nbsp;</span
            ><span class="mtk7">5</span><span class="mtk1">;</span></span
          >
        </div>
        <div style="top: 396px; height: 18px;" class="view-line">
          <span
            ><span class="vs-whitespace">→&nbsp;&nbsp;&nbsp;</span
            ><span class="mtk1">undefinedVariable.foo&nbsp;=&nbsp;</span
            ><span class="mtk7">5</span
            ><span class="mtk1">;&nbsp;undefinedVariable.baz&nbsp;=&nbsp;</span
            ><span class="mtk7">10</span><span class="mtk1">;</span></span
          >
        </div>
        <div style="top: 414px; height: 18px;" class="view-line">
          <span><span>&nbsp;</span></span>
        </div>
        <div style="top: 432px; height: 18px;" class="view-line">
          <span
            ><span class="vs-whitespace">····</span
            ><span class="mtk6">function</span
            ><span class="mtk1"
              >&nbsp;initializeProperties(target,&nbsp;members)&nbsp;{</span
            ></span
          >
        </div>
        <div style="top: 324px; height: 18px;" class="view-line">
          <span
            ><span class="mtk20">on&nbsp;multiple&nbsp;lines'</span
            ><span class="mtk1">;</span></span
          >
        </div>
        <div style="top:252px;height:18px;" class="view-line">
          <span><span>&nbsp;</span></span>
        </div>
        <div style="top: 306px; height: 18px;" class="view-line">
          <span
            ><span class="mtk20">'a&nbsp;string</span
            ><span class="mtk11">\</span></span
          >
        </div>
        <div style="top:234px;height:18px;" class="view-line">
          <span
            ><span class="mtk6" dir="ltr">var</span
            ><span class="mtk1" dir="ltr">&nbsp;</span
            ><span class="mtk11" dir="ltr">קודמות</span
            ><span class="mtk1" dir="ltr">&nbsp;=&nbsp;</span
            ><span class="mtk20" dir="ltr"
              >"מיותר&nbsp;קודמות&nbsp;צ'ט&nbsp;של,&nbsp;אם&nbsp;לשון&nbsp;העברית&nbsp;שינויים&nbsp;ויש,&nbsp;אם"</span
            ><span class="mtk1" dir="ltr">;</span></span
          >
        </div>
        <div style="top:198px;height:18px;" class="view-line">
          <span><span class="mtk8">*/</span></span>
        </div>
        <div style="top:216px;height:18px;" class="view-line">
          <span><span>&nbsp;</span></span>
        </div>
        <div style="top:162px;height:18px;" class="view-line">
          <span
            ><span class="vs-whitespace">··</span
            ><span class="mtk8">Build:&nbsp;6.2.8100.0</span></span
          >
        </div>
        <div style="top:180px;height:18px;" class="view-line">
          <span
            ><span class="vs-whitespace">··</span
            ><span class="mtk8">Version:&nbsp;0.5</span></span
          >
        </div>
        <div style="top:144px;height:18px;" class="view-line">
          <span><span>&nbsp;</span></span>
        </div>
        <div style="top:126px;height:18px;" class="view-line">
          <span
            ><span class="vs-whitespace">··</span
            ><span class="mtk8"
              >This&nbsp;library&nbsp;is&nbsp;supported&nbsp;for&nbsp;use&nbsp;in&nbsp;Windows&nbsp;Tailo</span
            ><span class="mtk8">red&nbsp;Apps&nbsp;only.</span></span
          >
        </div>
        <div style="top:108px;height:18px;" class="view-line">
          <span><span>&nbsp;</span></span>
        </div>
        <div style="top:90px;height:18px;" class="view-line">
          <span
            ><span class="mtk8">blabla</span
            ><span class="vs-whitespace">→&nbsp;</span
            ><span class="mtk8 detected-link"
              >http://en.wikipedia.org/wiki/Timisoara</span
            ><span class="mtk8">&nbsp;bla&nbsp;bla</span></span
          >
        </div>
        <div style="top:72px;height:18px;" class="view-line">
          <span
            ><span class="mtk8">blabla</span
            ><span class="mtk8 detected-link"
              >http://en.wikipedia.org/wiki/Timisoara</span
            ><span class="mtk8">&nbsp;bla&nbsp;bla</span></span
          >
        </div>
        <div style="top:54px;height:18px;" class="view-line">
          <span
            ><span class="mtk8 detected-link">https://microsoft.com</span></span
          >
        </div>
        <div style="top:36px;height:18px;" class="view-line">
          <span><span>&nbsp;</span></span>
        </div>
        <div style="top:18px;height:18px;" class="view-line">
          <span
            ><span class="vs-whitespace">·</span
            ><span class="mtk8"
              >©&nbsp;Microsoft.&nbsp;All&nbsp;rights&nbsp;reserved.</span
            ></span
          >
        </div>
        <div style="top:0px;height:18px;" class="view-line">
          <span><span class="mtk8">/*</span></span>
        </div>
        <div style="top: 288px; height: 18px;" class="view-line">
          <span><span>&nbsp;</span></span>
        </div>
        <div style="top:270px;height:18px;" class="view-line">
          <span><span class="mtk6">function</span></span>
        </div>
      </div>
      <div
        data-mprt="1"
        class="contentWidgets"
        style="position: absolute; top: 0px;"
      >
        <div
          class="lightbulb-glyph"
          title="Show Fixes (⌘.)"
          widgetid="LightBulbWidget"
          style="position: absolute; visibility: hidden; max-width: 671px;"
        ></div>
      </div>
      <div
        role="presentation"
        aria-hidden="true"
        class="cursors-layer cursor-line-style cursor-solid"
      >
        <div
          class="cursor "
          style='height: 18px; top: 270px; left: 64px; font-family: Menlo, Monaco, "Courier New", monospace; font-weight: normal; font-size: 12px; line-height: 18px; letter-spacing: 0px; display: block; visibility: hidden; width: 1.66667px;'
        ></div>
      </div>
    </div>
    <div
      role="presentation"
      aria-hidden="true"
      class="visible scrollbar horizontal"
      style="position: absolute; width: 657px; height: 10px; left: 0px; bottom: 0px;"
    >
      <div
        class="slider"
        style="position: absolute; top: 0px; left: 0px; height: 10px; will-change: transform; width: 435px;"
      ></div>
    </div>
    <canvas
      class="decorationsOverviewRuler"
      aria-hidden="true"
      width="25"
      height="809"
      style="position: absolute; will-change: transform; top: 0px; right: 0px; width: 14px; height: 450px;"
    ></canvas>
    <div
      role="presentation"
      aria-hidden="true"
      class="visible scrollbar vertical"
      style="position: absolute; width: 14px; height: 450px; right: 0px; top: 0px;"
    >
      <div
        class="slider"
        style="position: absolute; top: 0px; left: 0px; width: 14px; will-change: transform; height: 45px;"
      ></div>
    </div>
  </div>
  <div
    role="presentation"
    aria-hidden="true"
    style="width: 741px;"
    class=""
  ></div>
  <textarea
    data-mprt="6"
    class="inputarea"
    wrap="off"
    autocorrect="off"
    autocapitalize="off"
    autocomplete="off"
    spellcheck="false"
    aria-label="Editor content;Press Alt+F1 for Accessibility Options."
    role="textbox"
    aria-multiline="true"
    aria-haspopup="false"
    aria-autocomplete="both"
    style='font-size: 1px; line-height: 18px; top: 270px; left: 148px; width: 1px; height: 1px; font-family: Menlo, Monaco, "Courier New", monospace; font-weight: normal; letter-spacing: 0px;'
  ></textarea>
  <div
    style="position: absolute; top: 0px; left: 0px; width: 0px; height: 0px;"
    class="monaco-editor-background textAreaCover margin"
  ></div>
  <div data-mprt="4" class="overlayWidgets" style="width: 800px;">
    <div
      class="accessibilityHelpWidget"
      role="dialog"
      aria-hidden="true"
      widgetid="editor.contrib.accessibilityHelpWidget"
      style="display: none; position: absolute;"
    >
      <div role="document"></div>
    </div>
    <div
      class="monaco-editor-hover hidden"
      aria-hidden="true"
      role="presentation"
      widgetid="editor.contrib.modesGlyphHoverWidget"
      style="position: absolute;"
    ></div>
  </div>
  <div
    data-mprt="8"
    class="minimap slider-mouseover"
    role="presentation"
    aria-hidden="true"
    style="position: absolute; left: 741px; width: 45px; height: 450px;"
  >
    <div class="minimap-shadow-visible" style="height: 450px;"></div>
    <canvas
      width="80"
      height="809"
      style="position: absolute; left: 0px; width: 44.4444px; height: 449.444px;"
    ></canvas>
    <div
      class="minimap-slider"
      style="position: absolute; will-change: transform; width: 45px; top: 0px; height: 27px;"
    >
      <div
        class="minimap-slider-horizontal"
        style="position: absolute; left: 0px; width: 45px; top: 0px; height: 27px;"
      ></div>
    </div>
  </div>
</div>
```
