# webGL程序的基本结构
WebGL程序由两部分组成：1. 着色器程序， 2. js代码
着色器是使用 OpenGL ES Shading Language(GLSL)编写的程序，
它携带着绘制形状的顶点信息以及构造绘制在屏幕上像素的所需数据(像素点的位置和颜色)。
绘制WebGL时候有两种不同的着色器函数，顶点着色器和片段着色器。
你需要通过用GLSL 编写这些着色器，并将代码文本传递给WebGL， 使之在GPU执行时编译。
顶点着色器和片段着色器的集合我们通常称之为着色器程序
着色器程序负责解决两个问题：
1. 坐标: 顶点着色器(vertex shader)提供了空间坐标
2. 颜色: 片元着色器(fragment shader)提供了颜色
坐标值的取值范围永远都是从 -1 到 +1, 而不关心canvas的实际尺寸.

## 1. 顶点着色器
每次渲染一个形状时，顶点着色器会在形状中的每个顶点运行。 
它的工作是将输入顶点从原始坐标系转换到WebGL使用的缩放空间(clipspace)坐标系，其中每个轴的坐标范围从-1.0到1.0，并且不考虑纵横比，实际尺寸或任何其他因素。

顶点着色器需要对顶点坐标进行必要的转换，在每个顶点基础上进行其他调整或计算，然后通过将其保存在由GLSL提供的特殊变量（我们称为gl_Position）中来返回变换后的顶点

顶点着色器根据需要， 也可以完成其他工作。例如，决定哪个包含 texel面部纹理的坐标，可以应用于顶点；通过法线来确定应用到顶点的光照因子等。然后将这些信息存储在变量（varyings)或属性(attributes)属性中，以便与片段着色器共享

以下的顶点着色器接收一个我们定义的属性（aVertexPosition）的顶点位置值。这个位置值是两个4x4矩阵uProjectionMatrix和uModelMatrix的乘积; gl_Position为结果值。
```js
// Vertex shader program

  const vsSource = `
    attribute vec4 aVertexPosition;

    uniform mat4 uModelViewMatrix;
    uniform mat4 uProjectionMatrix;

    void main() {
      gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
    }
    
  `;
```


## 2. 片元着色器
片段着色器在顶点着色器处理完图形的顶点后，会被要绘制的每个图形的每个像素点调用一次。它的职责是确定像素的颜色，通过指定应用到像素的纹理元素（也就是图形纹理中的像素），获取纹理元素的颜色，然后将应用适当的光照。之后颜色存储在特殊变量gl_FragColor中，返回到WebGL层。该颜色将最终绘制到屏幕上图形对应像素的对应位置
```js
const fsSource = `
    void main() {
      gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
    }
  `;
```




# webgl 坐标系
webgl采用的的右手坐标系，x轴方向向右，y轴方向向上，z轴方向向用户.
坐标原点在屏幕的正中心.
注意：这个和HTML页面中定义的方向不一样：x轴向右，y轴向下, 坐标原点为左上点.

# 1. 获取vertex和设置vertex

## step1. 在着色器程序中定义 Attribute
```js
`
attribute vec4 a_Position;
attribute float a_PointSize;

void main () {
    gl_Position = a_Position;
    gl_PointSize = a_PointSize;
}
`
```

## step2. 在js代码中获取着色器属性地址
```js
var a_Position = gl.getAttribLocation(gl.program, 'a_Position')
var a_PointSize = gl.getAttribLocation(gl.program, 'a_PointSize')
```

## step3. 对属性(地址)进行填值
对应的webgl的api为：
gl.vertexAttrib1f
gl.vertexAttrib2f
gl.vertexAttrib3f
gl.vertexAttrib4f
gl.vertexAttrib1fv
gl.vertexAttrib2fv
gl.vertexAttrib3fv
gl.vertexAttrib4fv
这里的后缀数字表示参数个数，f表示float(如果为i，表示int), v表示数组.
填值的过程相当于在原基础上的追加.

```js
gl.vertexAttrib3f(a_Position, 0.0, 0.0, 0.0)
// 或
gl.vertexAttrib4fv(
    a_Position, 
    new Float32Array([0.0, 0.0, 0.0, 1.0])    
)

gl.vertexAttrib1f(a_PointSize, 5.0)

```

## 2. 获取颜色和设置颜色
### step1. 在片元着色器程序中定义 uniform 或 varying （不能使用attribute）
uniform表示一致性的数据.
```js
`
precision mediump float;
uniform vec4 uFragColor;

void main () {
    gl_FragColor = uFragColor;
}
`
```

```js
var uFragColor = gl.getUniformLocation(gl.program, 'uFragColor')
gl.uniform4f(location, v0, v1, v2, v3)
```

## 缓冲区对象
使用缓冲区对象向vertex着色器传入多个顶点的数据，需要以下5个步骤.
处理其他对象，如纹理对象，帧缓冲区对象(光照)时的步骤也类似.
1. gl.createBuffer()
2. gl.bindBuffer(target, buffer)
target取值范围：
gl.ARRAY_BUFFER: 表示缓冲区对象中包含了顶点的数据.
gl.ELEMENT_ARRAY_BUFFER: 表示缓冲区对象中包含了顶点的索引值.

3. 将数据写入缓冲区对象: gl.bufferData(target, data, usage)
target同上.
usage: 表示程序将如何使用存储在缓冲区对象中的数据. 
该参数将帮助WebGL优化操作.即使传入一个错误值，也不会终止程序，只是为影响程序执行效率.
usage的取值范围：
gl.STATIC_DRAW: 只会向缓冲区对象中写入一次数据，但需要绘制很多次
gl.STREAM_DRAW: 只会向缓冲区对象中写入一次数据，然后绘制若干次
gl.DYNAMIC_DRAW: 会向缓冲区对象中多次写入数据，并绘制多次

4. 将缓冲区对象分配给一个attribute变量: gl.vertexAttribPointer(location, size, type, normalized, stride, offset)
size: 缓冲区中每个顶点的分量个数(1-4).
type: 每个分量的值类型
gl.UNSIGNED_BYTE  <=>   Uint8Array
gl.SHORT          <=>   Int16Array
gl.UNSIGNED_SHORT <=>   Uint16Array
gl.INT            <=>   Int32Array
gl.UNSIGNED_INT   <=>   Uint32Array
gl.FLOAT          <=>   Float32Array
normalized: true | false， 表示是否将非浮点型的数据归一化到 [0,1] 或 [-1,1] 区间
stride: 指定相邻两个顶点间的字节数, 默认为0
offset: 指定缓冲区对象中的偏移量(以字节为单位), 即attribute变量从缓冲区中的何处开始.

5. 开启attribute变量: gl.enableVertexAttribArray(location)
可以使用gl.disableVertexAttribArray()来关闭分配.

## gl绘图模式
gl.POINTS: (需要在顶点着色器中指定gl_PointSize)
gl.LINES: 一系列单独的线段,如果点数不是2的倍数，最后一个点会被忽略 (v0, v1), (v2, v3), (v4, v5), ...
gl.LINE_STRIP: 一系列连接的线段, (v0, v1), (v1, v2), (v2, v3), ...
gl.LINE_LOOP: 一系列连接的线段, 并且尾首闭合. (v0, v1), (v1, v2), ..., (vn, v0)
gl.TRIANGLES: 一系列单独的三角形, 如果点数不是3的倍数，剩下的点会被忽略, (v0, v1, v2), (v3, v4, v5)
gl.TRIANGLE_STRIP: 一系列连续的三角形, (v0, v1, v2), (v2, v1, v3), (v2, v3, v4), ...
下一个三角形的点顺序有调整，这是为了保证下一个三角形也是按照逆时针的顺序.
gl.TRIANGLE_FAN: 一系列三角形组成的基于第一个点的扇形, (v0, v1, v2), (v0, v2, v3), (v0, v3, v4)

