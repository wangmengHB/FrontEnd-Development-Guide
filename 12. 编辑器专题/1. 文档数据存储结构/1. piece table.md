
# Piece Table

这种数据结构是由 J Strother Moore 发明。 
在文本文档中表示一系列编辑的的典型数据结构。  
因为随后增加/删除的文本也是包含在 piece table 中，所以多层或无限制的 undo 可以通过 piece table 轻松实现。  
类似的数据结构：gap buffer.    

buffer 表示：保存内容的 immutable block .

一个 piece table （表）包含三列：
* which buffer
* start index in the buffer
* length in the buffer

除了 table 部分之外，使用两个 buffer 来处理编辑。       
* "Original buffer": A buffer to the original text document. This buffer is read-only.      
* "Add buffer": A buffer to a temporary file. This buffer is append-only.       












# Operations
Index
Definition: Index(i): return the character at position i

To retrieve the i-th character, the appropriate entry in a piece table is read.

Example
Given the following buffers and piece table:

Buffer	Content
Original file	ipsum sit amet
Add file	Lorem deletedtext dolor
Piece table
Which	Start Index	Length
Add	0	6
Original	0	6
Add	18	5
Original	6	9
To access the i-th character, the appropriate entry in the piece table is looked up.

For instance, to get the value of Index(15), the 3rd entry of piece table is retrieved. This is because the 3rd entry describes the characters from index 12 to 17 (the first entry describes characters in index 0 to 5, the next one is 6 to 11). The piece table entry instructs the program to look for the characters in the "add file" buffer, starting at index 18 in that buffer. The relative index in that entry is 3 (15 - 12), making the value of Index(15) the character "o".

For the buffers and piece table given above, the following text is shown:

Lorem ipsum dolor sit amet
The buffer implies such a sequence of action:

start:   ipsum  sit amet              (piece table is now Original[0,9])
insert:  Lorem ipsum  sit amet        (piece table is now Add[0,6], Original[0,9])
insertion of " deletedtext " somewhere
"deletedtext" is removed              (but it stays in the Add buffer)
insert:  Lorem ipsum dolor sit amet   (piece table ends at the final state)
Insert
Inserting characters to the text consists of:

Appending characters to the "add file" buffer, and
Updating the entry in piece table (breaking an entry into two or three)
Delete
Deletion involves only modifying the appropriate entry in piece table.

Time complexity
Although a piece table itself is a data structure, it does not state how it should be implemented. The time complexity of operations depends on how the table is being implemented. One possible implementation of a piece table is in a splay tree, because it provides quick access to recently-accessed elements.[3]

Usage
Several text editors use an in-RAM piece table internally, including Bravo,[1]Abiword[4][5][6], Atom[3] and Visual Studio Code.[7]

The "fast save" feature in some versions of Microsoft Word uses a piece table for the on-disk file format.[2]

The on-disk representation of text files in the Oberon System uses a piece chain technique that allows pieces of one document to point to text stored in some other document, similar to transclusion. [8]



> 参考文章：
1. https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation
2. https://mrale.ph/
3. https://mrale.ph/blog/2018/02/03/maybe-you-dont-need-rust-to-speed-up-your-js.html
4. https://en.wikipedia.org/wiki/Piece_table
5. https://darrenburns.net/posts/piece-table/


















